name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pyside6

      - name: Build EXE
        run: |
          pyinstaller --clean --noupx --onedir --windowed --collect-all PySide6 `
            --name TaiAnhSieuToc `
            --icon .\app.ico `
            .\image_downloader_app.py

      - name: Zip build
        run: |
          Compress-Archive -Path "dist/TaiAnhSieuToc/*" -DestinationPath "dist/TaiAnhSieuToc_${{ github.ref_name }}.zip"

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: Release ${{ github.ref_name }}: build and auto-update package
          files: |
            dist/TaiAnhSieuToc_${{ github.ref_name }}.zip

      - name: Update manifest (version, url, sha256)
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          $zipPath = "dist/TaiAnhSieuToc_${{ github.ref_name }}.zip"
          $sha256 = (Get-FileHash -Algorithm SHA256 $zipPath).Hash.ToLower()
          $url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/TaiAnhSieuToc_${{ github.ref_name }}.zip"
          $manifest = @{
            version = $ver
            windows = @{
              url = $url
              sha256 = $sha256
            }
            notes = "Phát hành $ver"
          } | ConvertTo-Json -Depth 10
          $manifest | Out-File -Encoding utf8 public/tai_anh_sieu_toc.json

      - name: Commit manifest update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/tai_anh_sieu_toc.json
          git commit -m "chore: update manifest to ${{ github.ref_name }}"
          git push
