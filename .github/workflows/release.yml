name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build EXE
        run: |
          pyinstaller --clean --noupx --onedir --windowed --collect-all PySide6 `
            --name TaiAnhSieuToc `
            --icon .\app.ico `
            .\image_downloader_app.py

      - name: Zip build
        run: |
          Compress-Archive -Path "dist/TaiAnhSieuToc/*" -DestinationPath "dist/TaiAnhSieuToc_${{ github.ref_name }}.zip"

      - name: Create GitHub Release + upload ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: Release ${{ github.ref_name }}: build and auto-update package
          files: |
            dist/TaiAnhSieuToc_${{ github.ref_name }}.zip

      - name: Update manifest (version, url, sha256)
        shell: pwsh
        run: |
          $zipPath = "dist/TaiAnhSieuToc_${{ github.ref_name }}.zip"
          $sha256 = (Get-FileHash $zipPath -Algorithm SHA256).Hash
          $manifest = @{
            version = "${{ github.ref_name }}"
            windows = @{
              url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/TaiAnhSieuToc_${{ github.ref_name }}.zip"
              sha256 = $sha256
            }
            notes = "Phát hành ${{ github.ref_name }}"
          } | ConvertTo-Json -Depth 3
          Set-Content -Path public/tai_anh_sieu_toc.json -Value $manifest -Encoding UTF8
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add public/tai_anh_sieu_toc.json
          git commit -m "chore: update manifest to ${{ github.ref_name }}"
          git push
